<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <title>Character Home</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #ffffff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            background-color: #1e1e1e;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            flex-grow: 1;
        }
        h1 {
            font-size: 2.5rem;
            color: #ffffff;
        }
        .btn {
            font-size: 1.1rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .footer-icons {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background-color: #343a40;
            padding: 10px 0;
            text-align: center;
        }
        .footer-icons .btn {
            margin: 0 15px;
            padding: 10px 20px;
        }
        .footer-icons i {
            margin-right: 8px;
        }
        .search-section {
            text-align: center;
            margin-bottom: 30px;
        }
        .search-input {
            width: 300px;
            padding: 10px;
            font-size: 1rem;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #333;
            color: #fff;
        }
        .search-input:focus {
            outline: none;
            border-color: #007bff;
        }
        .search-button {
            background-color: #007bff;
            color: white;
            margin-top: 10px;
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            transition: background-color 0.3s ease;
        }
        .search-button:hover {
            background-color: #0056b3;
        }
        .sidebar {
            position: fixed;
            top: 20%;
            left: 0;
            background-color: #343a40;
            width: 60px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .sidebar .btn {
            background-color: #007bff;
            color: white;
            margin-bottom: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            padding: 0;
        }
        .sidebar .btn:hover {
            background-color: #0056b3;
        }
        @media (max-width: 768px) {
            .search-input {
                width: 80%;
            }
        }
    </style>
</head>
<body>
    <div id="loadingPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div style="text-align: center; color: white;">
            <div style="margin-bottom: 20px;">Loading...</div>
            <div style="width: 100%; background-color: #555; border-radius: 5px;">
                <div id="loadingBar" style="width: 0%; height: 20px; background-color: #007bff; border-radius: 5px;"></div>
            </div>
        </div>
    </div>
    <script>
        function showLoadingPopup() {
            const loadingPopup = document.getElementById('loadingPopup');
            loadingPopup.style.display = 'flex';
            let width = 0;
            const loadingBar = document.getElementById('loadingBar');
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                } else {
                    width++;
                    loadingBar.style.width = width + '%';
                }
            }, 30);
        }

        function hideLoadingPopup() {
            const loadingPopup = document.getElementById('loadingPopup');
            loadingPopup.style.display = 'none';
        }

        document.addEventListener('DOMContentLoaded', () => {
            const fetchCharacters = () => {
                const startTime = performance.now();
                showLoadingPopup();
                fetch('https://server-hhcx.onrender.com/characters')
                    .then(response => response.text())
                    .then(data => {
                        const charactersContainer = document.getElementById('characters');
                        charactersContainer.innerHTML = data;
                        const endTime = performance.now();
                        const timeElement = document.getElementById('time');
                        timeElement.style.fontFamily = "'Press Start 2P', cursive";
                        timeElement.style.color = '#00ff00';
                        timeElement.style.textShadow = '0 0 10px rgba(0,255,0,0.5)';
                        timeElement.style.fontSize = '1.2em';
                        timeElement.style.letterSpacing = '2px';
                        timeElement.textContent = `Characters loaded in ${(endTime - startTime).toFixed(2)} ms`;
                        timeElement.classList.add('animate__animated', 'animate__bounceIn', 'animate__delay-1s');
                        timeElement.addEventListener('mouseover', () => {
                            timeElement.classList.remove('animate__bounceIn');
                            timeElement.classList.add('animate__pulse');
                        });
                        timeElement.addEventListener('mouseout', () => {
                            timeElement.classList.remove('animate__pulse');
                        });
                        hideLoadingPopup();
                    })
                    .catch(error => {
                        console.error('Error loading characters:', error);
                        hideLoadingPopup();
                    });
            };
        });
    </script>
    <div class="text-center mt-3">
        <a href="http://agaga.com" class="d-inline-block rounded overflow-hidden shadow-lg transition-transform duration-300 ease-in-out transform hover:scale-105" style="font-weight: bold; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">
            <img src="./IMAGES/footer.png" alt="Footer Image" class="rounded" style="max-width: 40%; height: auto; border-radius: 20px; filter: brightness(1.1); padding: 8px; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">
        </a>
    </div>
    <style>
        .text-center a {
            position: relative;
            display: inline-block;
        }
        .text-center a::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 25px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0);
            transition: box-shadow 0.3s ease;
        }
        .text-center a:hover::after {
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
    </style>
    <h1 style="position: absolute; top: 10px; left: 10px; font-size: 1.5rem; color: #ffffff; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;">FlexDapt</h1>
    <div class="search-section d-flex justify-content-center align-items-center mb-4" style="font-size: 1.2rem;">
        <input type="text" class="search-input form-control me-2" placeholder="Search characters..." aria-label="Search characters" style="padding: 8px; width: 80%;">
        <button class="search-button btn btn-primary" style="padding: 8px 16px; font-size: 1rem;">Search</button>
    </div>
    <div class="dropdown mb-3" id="tagsDropdownContainer">
        <div class="d-flex align-items-center">
            <button class="btn btn-dark dropdown-toggle" type="button" id="tagsDropdown" aria-expanded="false">
                Tags
            </button>
            <div id="selectedTags" class="d-flex flex-wrap ms-2"></div>
        </div>
        <p id="time"></p>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                fetchCharacters();
                initializeDropdown();
            });

            function initializeDropdown() {
                const dropdownButton = document.getElementById('tagsDropdown');
                const dropdownMenu = document.querySelector('.dropdown-menu');
                
                if (dropdownButton) {
                    dropdownButton.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (dropdownMenu) {
                            dropdownMenu.classList.toggle('show');
                        }
                    });
                }
            }

            function fetchCharacters() {
                const startTime = performance.now();
                fetch('https://server-hhcx.onrender.com/characters')
                    .then(response => response.text())
                    .then(data => {
                        const charactersContainer = document.getElementById('characters');
                        charactersContainer.innerHTML = data;
                        const endTime = performance.now();
                        document.getElementById('time').textContent = `Characters loaded in ${(endTime - startTime).toFixed(2)} ms`;
                    })
                    .catch(error => console.error('Error loading characters:', error));
            }
        </script>
        <ul class="dropdown-menu animate__animated animate__fadeIn" aria-labelledby="tagsDropdown" style="background-color: black; z-index: 999; pointer-events: auto;" id="tagsList">
            <li><a class="dropdown-item" style="color: white;" href="#" onclick="handleTagClick('Villain')">Villain</a></li>
            <li><a class="dropdown-item" style="color: white;" href="#" onclick="handleTagClick('Hero')">Hero</a></li>
            <li><a class="dropdown-item" style="color: white;" href="#" onclick="handleTagClick('Sci-Fi')">Sci-Fi</a></li>
            <li><a class="dropdown-item" style="color: white;" href="#" onclick="handleTagClick('Fantasy')">Fantasy</a></li>
            <li><a class="dropdown-item" style="color: white;" href="#" onclick="handleTagClick('Male')">Male</a></li>
            <li><a class="dropdown-item" style="color: white;" href="#" onclick="handleTagClick('Female')">Female</a></li>
            <li><a class="dropdown-item" style="color: white;" href="#" onclick="handleTagClick('None')">None</a></li>
        </ul>
        <script>
            fetch('https://server-hhcx.onrender.com/tags')
                .then(response => response.json())
                .then(tags => {
                    const tagsList = document.getElementById('tagsList');
                    tags.forEach(tag => {
                        if (!tagsList.innerHTML.includes(tag)) {
                            const li = document.createElement('li');
                            li.innerHTML = `<a class="dropdown-item" style="color: white;" href="#" onclick="handleTagClick('${tag}')">${tag}</a>`;
                            tagsList.appendChild(li);
                        }
                    });
                })
                .catch(error => console.error('Error loading tags:', error));
                
            const selectedTags = new Set();

            function handleTagClick(tag) {
                if (tag === 'None') {
                    selectedTags.clear();
                } else {
                    selectedTags.add(tag);
                }
                updateSelectedTagsDisplay();
                filterCharacters();
            }

            function removeTag(tag) {
                selectedTags.delete(tag);
                updateSelectedTagsDisplay();
                filterCharacters();
            }

            function updateSelectedTagsDisplay() {
                const container = document.getElementById('selectedTags');
                container.innerHTML = '';
                selectedTags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'badge bg-primary me-1 mb-1';
                    tagElement.style.padding = '5px 10px';
                    tagElement.style.borderRadius = '15px';
                    tagElement.innerHTML = `${tag} <span style="cursor: pointer; margin-left: 5px" onclick="removeTag('${tag}')">&times;</span>`;
                    container.appendChild(tagElement);
                });
            }

            function filterCharacters() {
                fetch('https://server-hhcx.onrender.com/characterdata')
                    .then(response => response.text())
                    .then(data => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(data, 'text/html');
                        const characters = Array.from(doc.querySelectorAll('#characters .character'));
                        const filteredCharacters = selectedTags.size === 0 ? 
                            characters : 
                            characters.filter(character => 
                                Array.from(selectedTags).every(tag => 
                                    character.dataset.tags.includes(tag)
                                )
                            );
                        const charactersContainer = document.getElementById('characters');
                        charactersContainer.innerHTML = '';
                        filteredCharacters.forEach(character => charactersContainer.appendChild(character));
                    });
            }
        </script>
    </div>
    </div>
    <script>
        const searchInput = document.querySelector('.search-input');
        const tagsDropdownContainer = document.getElementById('tagsDropdownContainer');
        const updateTagsDropdownPosition = () => {
            const searchInputRect = searchInput.getBoundingClientRect();
            tagsDropdownContainer.style.position = 'absolute';
            tagsDropdownContainer.style.top = `${window.innerWidth <= 768 ? searchInputRect.bottom + 10 : 300}px`;
            tagsDropdownContainer.style.left = `${searchInputRect.left}px`;
            tagsDropdownContainer.style.width = `${searchInputRect.width}px`;
        };
        updateTagsDropdownPosition();
        window.addEventListener('resize', updateTagsDropdownPosition);
        window.addEventListener('orientationchange', updateTagsDropdownPosition);
    </script>
    <div class="container text-center mt-5">
        <div id="characters" class="row">
            
        </div>
    </div>

    <div class="footer-icons" style="background-color: rgba(255, 255, 255, 0.5); padding: 15px; border-radius: 8px; position: fixed; left: 0; bottom: 0; width: 100%; display: flex; justify-content: center; flex-wrap: wrap;">
        <button id="userPersonaBtnFooter" class="btn btn-light" style="margin: 5px;">
            <i class="bi bi-person"></i> User Persona
        </button>
        <button id="settingsBtnFooter" class="btn btn-light" style="margin: 5px;" onclick="openSettings()">
            <i class="bi bi-gear"></i> Settings
        </button>
        <div id="settingsOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 1000; justify-content: center; align-items: center;">
            <div style="background-color: black; padding: 20px; border-radius: 10px; width: 300px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);">
                <h2 style="color: white; text-align: center; margin-bottom: 15px;">Settings</h2>
                <div id="loggedOutButtons" style="display: none;">
                    <button id="registerBtn" class="btn btn-secondary" style="width: 100%;" onclick="window.location.href='./register/register.html'">Register</button>
                    <button id="loginBtn" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="window.location.href='./login/login.html'">Log In</button>
                </div>
                <div id="loggedInButtons" style="display: none;">
                    <button id="registerBtn" class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="window.location.href='./register/register.html'">Register</button>
                    <button id="loginBtn" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="window.location.href='./login/login.html'">Log In</button>
                    <button id="logoutBtn" class="btn btn-danger" style="width: 100%;" onclick="confirmLogout()">Log Out</button>
                </div>
                <button id="closeSettingsBtn" class="btn btn-light" style="width: 100%; margin-top: 10px;">❌ Close</button>
                <script>
                    const userId = localStorage.getItem('userId');
                    document.getElementById('loggedInButtons').style.display = userId ? 'block' : 'none';
                    document.getElementById('loggedOutButtons').style.display = userId ? 'none' : 'block';
                </script>
            </div>
            <script>
                function confirmLogout() {
                    window.location.href = './Goodbye.html';
                }
            </script>
        </div>
        <script>
            function openSettings() {
                document.getElementById('settingsOverlay').style.display = 'flex';
            }
            document.getElementById('closeSettingsBtn').addEventListener('click', function() {
                document.getElementById('settingsOverlay').style.display = 'none';
            });
        </script>
    </div>
    <div id="overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); z-index: 1000; justify-content: center; align-items: center; animation: fadeIn 0.5s;">
        <div style="background-color: black; padding: 20px; border-radius: 10px; width: 300px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);">
            <h2 style="color: white; text-align: center; margin-bottom: 15px;">Create Persona</h2>
            <input type="text" id="personaName" placeholder="Name" style="width: 100%; margin-bottom: 10px; padding: 10px; border: none; border-radius: 5px; background-color: #333; color: white;"/>
            <input type="text" id="personaDescription" placeholder="Description" style="width: 100%; margin-bottom: 10px; padding: 10px; border: none; border-radius: 5px; background-color: #333; color: white;"/>
            <input type="text" id="personaPhoto" placeholder="Profile Picture URL" style="width: 100%; margin-bottom: 10px; padding: 10px; border: none; border-radius: 5px; background-color: #333; color: white;"/>
            <button id="savePersonaBtn" class="btn btn-primary" style="width: 100%; background-color: #007bff; border: none; border-radius: 5px; padding: 10px; color: white; font-weight: bold;">💾 Save</button>
            <button id="closeOverlayBtn" class="btn btn-secondary" style="width: 100%; margin-top: 10px; background-color: #6c757d; border: none; border-radius: 5px; padding: 10px; color: white; font-weight: bold;">❌ Close</button>
        </div>
    </div>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
    <script>
        document.getElementById('userPersonaBtnFooter').addEventListener('click', function() {
            document.getElementById('overlay').style.display = 'flex';
        });
        
        document.getElementById('closeOverlayBtn').addEventListener('click', function() {
            document.getElementById('overlay').style.display = 'none';
        });

        document.getElementById('userPersonaBtnFooter').addEventListener('click', function() {
            fetch('https://server-hhcx.onrender.com/persona')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('personaName').value = data.Name || '';
                    document.getElementById('personaDescription').value = data.Description || '';
                })
                .catch(() => {
                    alert('Error fetching persona data');
                });
            document.getElementById('overlay').style.display = 'flex';
        });
        document.addEventListener('click', function(event) {
            if (event.target.id === 'savePersonaBtn') {
                const name = document.getElementById('personaName').value.trim();
                const description = document.getElementById('personaDescription').value.trim();
                const photo = document.getElementById('personaPhoto').value.trim();
                if (name && description && photo) {
                    fetch('https://server-hhcx.onrender.com/persona', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ "Name": name, "Description": description, "Photo": photo })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message) {
                            document.getElementById('overlay').style.display = 'none';
                            alert('Persona data saved successfully');
                        } else {
                            alert(data.error || 'Error saving persona data');
                        }
                    })
                    .catch(() => {
                        alert('Error saving persona data');
                    });
                } else {
                    alert('Please fill in all fields.');
                }
            }
        });
    </script>

    <div class="sidebar" id="sidebar">
        <button class="btn btn-primary" onclick="window.location.href='chats.html'">
            <i class="bi bi-chat"></i>
        </button>
        <button class="btn btn-light" id="createBtnFooter" onclick="window.location.href='create.html'">
            <i class="bi bi-plus-circle"></i> 
        </button>
    </div>
    <button id="toggleSidebar" class="btn btn-primary" style="position: fixed; left: 65px; top: 185px; background-color: blue; border: none; color: white;">
        <i class="bi bi-arrow-left" id="toggleIcon"></i>
    </button>
    <style>
        .sidebar {
            transition: transform 0.3s ease;
            transform: translateX(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 10px;
            border-radius: 5px;
        }
        .sidebar.hidden {
            transform: translateX(-100%);
        }
        #toggleSidebar:hover {
            background-color: darkblue;
        }
    </style>
    <script>
        document.getElementById('toggleSidebar').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = document.getElementById('toggleIcon');
            const toggleBtn = document.getElementById('toggleSidebar');
            const isHidden = sidebar.classList.toggle('hidden');
            
            toggleIcon.classList.toggle('bi-arrow-left');
            toggleIcon.classList.toggle('bi-arrow-right');
            
            const startPosition = isHidden ? 65 : 0;
            const endPosition = isHidden ? 0 : 65;
            const duration = 300;
            const startTime = performance.now();
            
            if (isHidden) {
                toggleBtn.style.opacity = 0.5;
            } else {
                toggleBtn.style.opacity = 1;
            }
            
            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                
                const currentPosition = startPosition + (endPosition - startPosition) * easeProgress;
                toggleBtn.style.left = `${currentPosition}px`;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                }
            }
            
            requestAnimationFrame(animate);
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    function customAlert(message) {
    const alertBox = document.createElement('div');
    alertBox.style.position = 'fixed';
    alertBox.style.top = '20px';
    alertBox.style.left = '50%';
    alertBox.style.transform = 'translateX(-50%)';
    alertBox.style.backgroundColor = '#444';
    alertBox.style.color = '#fff';
    alertBox.style.padding = '15px';
    alertBox.style.borderRadius = '10px';
    alertBox.style.zIndex = '10000';
    alertBox.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.7)';
    alertBox.style.transition = 'opacity 0.5s ease, transform 0.5s ease, box-shadow 0.5s ease';
    alertBox.style.opacity = '0';
    alertBox.style.transform += ' translateY(-20px)';
    alertBox.style.pointerEvents = 'none';
    alertBox.style.userSelect = 'none';
    alertBox.innerHTML = `<i class="fas fa-info-circle" style="margin-right: 8px;"></i>${message}`;
    alertBox.style.fontFamily = "'Roboto', sans-serif";
    document.body.appendChild(alertBox);

    requestAnimationFrame(() => {
        alertBox.style.opacity = '1';
        alertBox.style.transform = 'translateX(-50%) translateY(0)';
    });

    setTimeout(() => {
        alertBox.style.opacity = '0';
        alertBox.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => {
            document.body.removeChild(alertBox);
        }, 500);
    }, 3000);
}

window.alert = customAlert;

(function() {
    const originalLog = console.log;
    const originalError = console.error;

    console.log = function(...args) {
        const formattedArgs = args.map(arg => {
            if (typeof arg === 'string') {
                return `💬 ${arg}`;
            }
            return arg;
        });
        originalLog.apply(console, formattedArgs);
    };

    console.error = function(...args) {
        const formattedArgs = args.map(arg => {
            if (typeof arg === 'string') {
                return `❌ ${arg}`;
            }
            return arg;
        });
        originalError.apply(console, formattedArgs);
    };
})();

    </script>
</body>
</html>
