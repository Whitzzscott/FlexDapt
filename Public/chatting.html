<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Loading...</title>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const characterId = urlParams.get('id');

        if (characterId) {
            fetch(`https://server-hhcx.onrender.com/characterdata/id?id=${characterId}`)
                .then(response => response.json())
                .then(result => {
                    const decodedData = result.data ? atob(result.data) : null;
                    if (decodedData) {
                        const characterData = JSON.parse(decodedData);
                        document.getElementById('pageTitle').textContent = characterData.name;
                    } else {
                        document.getElementById('pageTitle').textContent = 'Character Chat';
                    }
                })
                .catch(() => {
                    document.getElementById('pageTitle').textContent = 'Character Chat';
                });
        } else {
            document.getElementById('pageTitle').textContent = 'Character Chat';
        }
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #181818;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
        }


        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #232323;
            border-radius: 10px;
            overflow: hidden;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 20px;
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
        }

        .header img {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 15px;
        }

        .header h3 {
            margin: 0;
        }

        .chat-box {
            flex: 1;
            overflow-y: scroll;
            padding: 20px;
            background-color: #2c2c2c;
        }

        .message {
            display: flex;
            align-items: flex-end;
            margin-bottom: 15px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message .message-content {
            max-width: 75%;
            padding: 10px;
            border-radius: 20px;
            font-size: 16px;
        }

        .message.user .message-content {
            background-color: #4a90e2;
            color: white;
        }

        .message.bot .message-content {
            background-color: #555;
            color: white;
        }

        .input-area {
            display: flex;
            padding: 15px;
            background-color: #232323;
            border-top: 1px solid #333;
        }

        .input-area input {
            flex: 1;
            border: none;
            padding: 10px;
            border-radius: 20px;
            margin-right: 10px;
            background-color: #3a3a3a;
            color: white;
        }

        .input-area button {
            background-color: #4a90e2;
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
        }

        .input-area button:hover {
            background-color: #357ab7;
        }

        .message-time {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h3><i class="fas fa-robot"></i> Creative Helper</h3>
        <div class="btn-group">
            <button class="btn"><i class="fas fa-plus"></i> New Chat</button>
            <button class="btn"><i class="fas fa-cog"></i> Settings</button>
            <button class="btn"><i class="fas fa-question-circle"></i> Help</button>
        </div>
    </div>
<style>
        .sidebar {
            width: 250px;
            background-color: #232323;
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.5);
        }

        .sidebar h3 {
            color: #4a90e2;
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar .btn {
            color: #fff;
            background-color: #4a90e2;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .sidebar .btn i {
            font-size: 14px;
        }

        .sidebar .btn:hover {
            background-color: #357ab7;
            transform: translateY(-1px);
        }
</style>
    <div class="chat-container">
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
        <div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; justify-content: center; align-items: center; z-index: 2000; transition: background 0.3s;">
            <div class="spinner" style="width: 60px; height: 60px; border: 6px solid rgba(255, 255, 255, 0.3); border-top: 6px solid #4a90e2; border-radius: 50%; animation: spin 1s linear infinite; animation: spin 1s linear infinite, move 2s ease-in-out infinite alternate;"></div>
        </div>

        <div class="header" style="display: flex; align-items: center; padding: 15px; cursor: pointer;" onclick="document.getElementById('characterOverlay').style.display='block'">
            <img src="" alt="Bot Avatar" id="characterAvatar" style="border-radius: 50%; width: 60px; height: 60px; margin-right: 15px;">
            <div>
                <h3 id="characterName" style="margin: 0; color: #4a90e2; font-size: 1.5rem;">NULL</h3>
                <p id="characterDescription" style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 20ch; color: #e0e0e0; margin-top: 5px;">NULL</p>
            </div>
        </div>

        <div id="characterOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1000; backdrop-filter: blur(5px);" onclick="document.getElementById('characterOverlay').style.display='none'">
            <div style="position: relative; max-width: 600px; margin: 50px auto; background: #2c2c2c; padding: 30px; border-radius: 15px; color: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);" onclick="event.stopPropagation();">
                <button onclick="document.getElementById('characterOverlay').style.display='none'" style="position: absolute; right: 15px; top: 15px; background: none; border: none; color: #ff4d4d; font-size: 24px; cursor: pointer; transition: color 0.3s;">
                    Ã—
                </button>
                <img id="overlayCharacterAvatar" src="" alt="Character" style="width: 160px; height: 160px; border-radius: 80px; margin: 0 auto 20px; display: block; border: 3px solid #4a90e2; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">
                <h2 id="overlayCharacterName" style="text-align: center; margin-bottom: 20px; font-size: 1.8rem; font-weight: bold;"></h2>
                <div id="overlayCharacterDescription" style="margin-bottom: 20px; line-height: 1.6; font-size: 1rem;"></div>
                <div id="overlayCharacterPersona" style="margin-bottom: 20px; line-height: 1.6; font-size: 1rem;"></div>
            </div>
        </div>

        <div class="chat-box" id="chatBox" style="scrollbar-width: thin; scrollbar-color: transparent transparent;">
            <div class="message bot">
                <div class="message-content" id="firstMessageContent">
                </div>
            </div>
            <div id="previewMessage" style="display: none; margin: 10px; padding: 15px; background-color: rgba(74, 144, 226, 0.1); border-radius: 10px; color: #888; font-style: italic;">
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Type your message..." oninput="showPreview(this.value)" onkeydown="if(event.key === 'Enter') { hidePreview(); }" />
            <button id="sendBtn" onclick="hidePreview()"><i class="fas fa-paper-plane"></i></button>
        </div>
        <script>
            function showPreview(text) {
                const preview = document.getElementById('previewMessage');
                if (text.trim() === '') {
                    preview.style.display = 'none';
                } else {
                    preview.style.display = 'block';
                    preview.textContent = text;
                }
            }

            function hidePreview() {
                const preview = document.getElementById('previewMessage');
                preview.style.display = 'none';
            }
        </script>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        document.getElementById('characterAvatar').addEventListener('click', function() {
            document.getElementById('characterOverlay').style.display = 'block';
        });

        const loadingOverlay = document.getElementById('loading-overlay');
        let characterData;
        
        Promise.all([
            fetch('https://server-hhcx.onrender.com/api/id/get')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => 
                    fetch('https://server-hhcx.onrender.com/characterdata/id?id=' + data.characterId)
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                )
        ]).then(([characterResponse]) => {
            const decodedData = JSON.parse(atob(characterResponse.data));
            characterData = decodedData;
            
            document.getElementById('firstMessageContent').innerText = decodedData.firstMessage;
            document.getElementById('characterName').innerText = decodedData.name;
            document.getElementById('characterDescription').innerText = decodedData.description;
            document.getElementById('characterAvatar').src = decodedData.photo;
            
            document.getElementById('overlayCharacterAvatar').src = decodedData.photo;
            document.getElementById('overlayCharacterName').innerText = decodedData.name;
            document.getElementById('overlayCharacterDescription').innerText = decodedData.description;
            document.getElementById('overlayCharacterPersona').innerText = decodedData.persona || 'No persona information available';
            
            loadingOverlay.style.opacity = '0';
            loadingOverlay.style.transition = 'opacity 0.5s ease-out';
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 500);
        })
        .catch(error => {
            console.error('Error:', error);
            loadingOverlay.style.display = 'none';
        });
        
        async function handleMessage() {
            let messageInput = document.getElementById('messageInput');
            let messageText = messageInput.value.trim();

            if (messageText) {
                let chatBox = document.getElementById('chatBox');
                let messageElement = document.createElement('div');
                messageElement.classList.add('message', 'user');

                try {
                    const response = await fetch('https://server-hhcx.onrender.com/persona');
                    if (!response.ok) {
                        throw new Error('Failed to fetch persona data');
                    }
                    const data = await response.json();
                    
                    let userPhoto = data.photo || 'default-avatar.png';
                    let userName = data.name || 'User';

                    let userInfo = document.createElement('div');
                    userInfo.classList.add('user-info');
                    userInfo.style.textAlign = 'center';
                    userInfo.innerHTML = `
                        <img src="${userPhoto}" alt="${userName}" style="
                        width: 40px; 
                        height: 40px; 
                        border-radius: 50%; 
                        display: block; 
                        position: absolute; 
                        top: 180px;">
                        <div style="font-weight: bold; 
                        color: #fff; 
                        position: absolute; 
                        top: 170px;
                        left: 160px;
                        ">${userName}</div>
                    `;
                    messageElement.appendChild(userInfo);

                    let messageContent = document.createElement('div');
                    messageContent.classList.add('message-content');
                    messageContent.innerText = messageText;
                    messageElement.appendChild(messageContent);

                    let timeStamp = document.createElement('div');
                    timeStamp.classList.add('message-time');
                    let currentTime = new Date();
                    timeStamp.innerText = currentTime.getHours() + ':' + String(currentTime.getMinutes()).padStart(2, '0');
                    messageElement.appendChild(timeStamp);

                    chatBox.appendChild(messageElement);
                    chatBox.scrollTop = chatBox.scrollHeight;
                } catch (error) {
                    console.error('Error fetching persona:', error);
                }
                messageInput.value = '';


                const settings = JSON.parse(localStorage.getItem('settings')) || {};

                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'message bot';
                typingIndicator.innerHTML = `
                    <div class="message-content" style="display: flex; align-items: center; gap: 4px;">
                        <div class="typing-indicator" style="display: flex; gap: 4px;">
                            <div style="width: 6px; height: 6px; border-radius: 50%; background: #B0B0B0; animation: bounce 1.2s infinite"></div>
                            <div style="width: 6px; height: 6px; border-radius: 50%; background: #B0B0B0; animation: bounce 1.2s infinite 0.3s"></div>
                            <div style="width: 6px; height: 6px; border-radius: 50%; background: #B0B0B0; animation: bounce 1.2s infinite 0.6s"></div>
                        </div>
                    </div>
                    <style>
                        @keyframes bounce {
                            0%, 80%, 100% { transform: translateY(0); }
                            40% { transform: translateY(-8px); }
                        }
                    </style>
                `;
                chatBox.appendChild(typingIndicator);
                chatBox.scrollTop = chatBox.scrollHeight;

                try {
                    const response = await fetch('https://server-hhcx.onrender.com/generatetext', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            prompt: messageText,
                            character: {
                                name: characterData.name,
                                description: characterData.description,
                                modelInstructions: characterData.modelInstructions,
                                system: characterData.system,
                                persona: characterData.persona,
                                firstMessage: characterData.firstMessage
                            },
                            max_tokens: settings.max_tokens || 100,
                            top_k: settings.top_k || 50,
                            temperature: settings.temperature || 0.7
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to get bot response');
                    }

                    const data = await response.json();
                    typingIndicator.remove();

                    let botMessageElement = document.createElement('div');
                    botMessageElement.classList.add('message', 'bot');

                    let botMessageContent = document.createElement('div');
                    botMessageContent.classList.add('message-content');
                    botMessageElement.appendChild(botMessageContent);

                    let botTimeStamp = document.createElement('div');
                    botTimeStamp.classList.add('message-time');
                    currentTime = new Date();
                    botTimeStamp.innerText = currentTime.getHours() + ':' + String(currentTime.getMinutes()).padStart(2, '0');
                    botMessageElement.appendChild(botTimeStamp);

                    chatBox.appendChild(botMessageElement);

                    for (let i = 0; i < data.result.response.length; i++) {
                        botMessageContent.innerText = data.result.response.substring(0, i + 1);
                        chatBox.scrollTop = chatBox.scrollHeight;
                        await new Promise(resolve => setTimeout(resolve, 20));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    typingIndicator.remove();
                    
                    let errorMessageElement = document.createElement('div');
                    errorMessageElement.classList.add('message', 'bot');
                    
                    let errorContent = document.createElement('div');
                    errorContent.classList.add('message-content');
                    errorMessageElement.appendChild(errorContent);
                    
                    let errorTimeStamp = document.createElement('div');
                    errorTimeStamp.classList.add('message-time');
                    currentTime = new Date();
                    errorTimeStamp.innerText = currentTime.getHours() + ':' + String(currentTime.getMinutes()).padStart(2, '0');
                    errorMessageElement.appendChild(errorTimeStamp);
                    
                    chatBox.appendChild(errorMessageElement);
                    
                    const errorMessage = 'Sorry, I encountered an error processing your message.';
                    for (let i = 0; i < errorMessage.length; i++) {
                        errorContent.innerText = errorMessage.substring(0, i + 1);
                        chatBox.scrollTop = chatBox.scrollHeight;
                        await new Promise(resolve => setTimeout(resolve, 20));
                    }
                }
            }
        }

        document.getElementById('sendBtn').addEventListener('click', handleMessage);
        
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleMessage();
            }
        });

        document.getElementById('messageInput').focus();
    </script>
</body>

</html>
