<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Loading...</title>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const characterId = urlParams.get('id');

        if (characterId) {
            fetch(`https://server-hhcx.onrender.com/characterdata/id?id=${characterId}`)
                .then(response => response.json())
                .then(result => {
                    const decodedData = result.data ? atob(result.data) : null;
                    if (decodedData) {
                        const characterData = JSON.parse(decodedData);
                        document.getElementById('pageTitle').textContent = characterData.name;
                    } else {
                        document.getElementById('pageTitle').textContent = 'Character Chat';
                    }
                })
                .catch(() => {
                    document.getElementById('pageTitle').textContent = 'Character Chat';
                });
        } else {
            document.getElementById('pageTitle').textContent = 'Character Chat';
        }
    </script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #181818;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            height: 100vh;
            display: flex;
        }


        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #232323;
            border-radius: 10px;
            overflow: hidden;
        }

        .header {
            display: flex;
            align-items: center;
            padding: 20px;
            background-color: #1e1e1e;
            border-bottom: 1px solid #333;
        }

        .header img {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-right: 15px;
        }

        .header h3 {
            margin: 0;
        }

        .chat-box {
            flex: 1;
            overflow-y: scroll;
            padding: 20px;
            background-color: #2c2c2c;
        }

        .message {
            display: flex;
            align-items: flex-end;
            margin-bottom: 15px;
            animation: fadeIn 0.5s ease-in-out;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message .message-content {
            max-width: 75%;
            padding: 10px;
            border-radius: 20px;
            font-size: 16px;
        }

        .message.user .message-content {
            background-color: #4a90e2;
            color: white;
        }

        .message.bot .message-content {
            background-color: #555;
            color: white;
        }

        .input-area {
            display: flex;
            padding: 15px;
            background-color: #232323;
            border-top: 1px solid #333;
        }

        .input-area input {
            flex: 1;
            border: none;
            padding: 10px;
            border-radius: 20px;
            margin-right: 10px;
            background-color: #3a3a3a;
            color: white;
        }

        .input-area button {
            background-color: #4a90e2;
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
        }

        .input-area button:hover {
            background-color: #357ab7;
        }

        .message-time {
            font-size: 0.8rem;
            color: #aaa;
            margin-top: 5px;
        }

        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
    </style>
</head>

<body>
    <div class="chat-container">
        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>
        <div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; justify-content: center; align-items: center; z-index: 2000; transition: background 0.3s;">
            <div class="spinner" style="width: 60px; height: 60px; border: 6px solid rgba(255, 255, 255, 0.3); border-top: 6px solid #4a90e2; border-radius: 50%; animation: spin 1s linear infinite; animation: spin 1s linear infinite, move 2s ease-in-out infinite alternate;"></div>
        </div>

        <div class="header" style="display: flex; align-items: center; justify-content: space-between; padding: 15px;">
            <div style="display: flex; align-items: center;">
                <button onclick="window.location.href='index.html'" style="background: none; border: none; color: white; font-size: 24px; padding: 0 15px 0 0; cursor: pointer; transition: background 0.3s; border-radius: 50%;"><i class="fas fa-arrow-left"></i></button>
                <div style="display: flex; align-items: center; cursor: pointer;" onclick="document.getElementById('characterOverlay').style.display='block'">
                    <img src="" alt="Bot Avatar" id="characterAvatar" style="border-radius: 50%; width: 60px; height: 60px; margin-right: 15px;">
                    <div>
                        <h3 id="characterName" style="margin: 0; color: #4a90e2; font-size: 1.5rem;">NULL</h3>
                        <p id="characterDescription" style="overflow: hidden; white-space: nowrap; text-overflow: ellipsis; max-width: 30ch; color: #e0e0e0; margin-top: 5px;">NULL</p>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="window.location.href='settings.html'" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; transition: background 0.3s, transform 0.3s; border-radius: 50%;"><i class="fas fa-cog"></i></button>
                <button onclick="window.location.href='guideline.html'" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; transition: background 0.3s, transform 0.3s; border-radius: 50%;"><i class="fas fa-question-circle"></i></button>
            </div>
        </div>

        <div id="characterOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 1000; backdrop-filter: blur(5px);" onclick="document.getElementById('characterOverlay').style.display='none'">
            <div style="position: relative; max-width: 600px; margin: 50px auto; background: #2c2c2c; padding: 30px; border-radius: 15px; color: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);" onclick="event.stopPropagation();">
                <button onclick="document.getElementById('characterOverlay').style.display='none'" style="position: absolute; right: 15px; top: 15px; background: none; border: none; color: #ff4d4d; font-size: 24px; cursor: pointer; transition: color 0.3s;">
                    Ã—
                </button>
                <img id="overlayCharacterAvatar" src="" alt="Character" style="width: 160px; height: 160px; border-radius: 80px; margin: 0 auto 20px; display: block; border: 3px solid #4a90e2; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);">
                <h2 id="overlayCharacterName" style="text-align: center; margin-bottom: 20px; font-size: 1.8rem; font-weight: bold;"></h2>
                <div id="overlayCharacterDescription" style="margin-bottom: 20px; line-height: 1.6; font-size: 1rem;"></div>
                <div id="overlayCharacterPersona" style="margin-bottom: 20px; line-height: 1.6; font-size: 1rem;"></div>
            </div>
        </div>

        <div class="chat-box" id="chatBox" style="scrollbar-width: thin; scrollbar-color: transparent transparent;">
            <div class="message bot">
                <div class="message-content" id="firstMessageContent">
                </div>
            </div>
            <div id="previewMessage" style="display: none; margin: 10px; padding: 15px; background-color: rgba(74, 144, 226, 0.1); border-radius: 10px; color: #888; font-style: italic;">
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Type your message..." oninput="showPreview(this.value)" onkeydown="if(event.key === 'Enter') { hidePreview(); }" />
            <button id="sendBtn" onclick="hidePreview()"><i class="fas fa-paper-plane"></i></button>
        </div>
        <script>
            function showPreview(text) {
                const preview = document.getElementById('previewMessage');
                if (text.trim() === '') {
                    preview.style.display = 'none';
                } else {
                    preview.style.display = 'block';
                    preview.textContent = text;
                }
            }

            function hidePreview() {
                const preview = document.getElementById('previewMessage');
                preview.style.display = 'none';
            }
        </script>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        document.getElementById('characterAvatar').addEventListener('click', function() {
            document.getElementById('characterOverlay').style.display = 'block';
        });

        const loadingOverlay = document.getElementById('loading-overlay');
        let characterData;
        
        Promise.all([
            fetch('https://server-hhcx.onrender.com/api/id/get')
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => 
                    fetch('https://server-hhcx.onrender.com/characterdata/id?id=' + data.characterId)
                        .then(response => {
                            if (!response.ok) throw new Error('Network response was not ok');
                            return response.json();
                        })
                )
        ]).then(([characterResponse]) => {
            const decodedData = JSON.parse(atob(characterResponse.data));
            characterData = decodedData;
            
            document.getElementById('firstMessageContent').innerText = decodedData.firstMessage;
            document.getElementById('characterName').innerText = decodedData.name;
            document.getElementById('characterDescription').innerText = decodedData.description;
            document.getElementById('characterAvatar').src = decodedData.photo;
            
            document.getElementById('overlayCharacterAvatar').src = decodedData.photo;
            document.getElementById('overlayCharacterName').innerText = decodedData.name;
            document.getElementById('overlayCharacterDescription').innerText = decodedData.description;
            document.getElementById('overlayCharacterPersona').innerText = decodedData.persona || 'No persona information available';
            
            loadingOverlay.style.opacity = '0';
            loadingOverlay.style.transition = 'opacity 0.5s ease-out';
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 500);
        })
        .catch(error => {
            console.error('Error:', error);
            loadingOverlay.style.display = 'none';
        });
        
        async function handleMessage() {
            let messageInput = document.getElementById('messageInput');
            let messageText = messageInput.value.trim();

            if (messageText) {
                let chatBox = document.getElementById('chatBox');
                let messageElement = document.createElement('div');
                messageElement.classList.add('message', 'user');

                let messageContent = document.createElement('div');
                messageContent.classList.add('message-content');
                messageContent.innerText = messageText;
                messageElement.appendChild(messageContent);

                try {
                    const response = await fetch('https://server-hhcx.onrender.com/persona');
                    if (!response.ok) {
                        throw new Error('Failed to fetch persona data');
                    }
                    const data = await response.json();
                    
                    let userPhoto = data.photo || 'default-avatar.png';
                    let userName = data.name || 'User';

                    let userInfo = document.createElement('div');
                    userInfo.classList.add('user-info');
                    userInfo.style.display = 'flex';
                    userInfo.style.alignItems = 'center';
                    userInfo.style.justifyContent = 'flex-start';
                    userInfo.style.marginBottom = '28px';
                    userInfo.style.marginLeft = '0';
                    userInfo.innerHTML = `
                        <div style="
                            font-weight: 500;
                            color: #fff;
                            font-size: 14px;
                        ">${userName}</div>
                    `;
                    messageElement.insertBefore(userInfo, messageContent);

                    let timeStamp = document.createElement('div');
                    timeStamp.classList.add('message-time');
                    let currentTime = new Date();
                    timeStamp.innerText = currentTime.getHours() + ':' + String(currentTime.getMinutes()).padStart(2, '0');
                    messageElement.appendChild(timeStamp);

                    messageElement.addEventListener('contextmenu', function(e) {
                        e.preventDefault();
                        const existingMenus = document.querySelectorAll('.context-menu');
                        existingMenus.forEach(menu => menu.remove());

                        const contextMenu = document.createElement('div');
                        contextMenu.classList.add('context-menu');
                        contextMenu.style.position = 'fixed';
                        contextMenu.style.left = e.pageX + 'px';
                        contextMenu.style.top = e.pageY + 'px';
                        contextMenu.style.backgroundColor = '#1a1a1a';
                        contextMenu.style.border = '1px solid #333';
                        contextMenu.style.borderRadius = '8px';
                        contextMenu.style.padding = '8px 0';
                        contextMenu.style.boxShadow = '0 4px 12px rgba(0,0,0,0.4)';
                        contextMenu.style.zIndex = '1000';
                        contextMenu.style.animation = 'fadeIn 0.2s ease-out';

                        const menuItems = [
                            { text: 'Remove', action: () => messageElement.remove() },
                            { text: 'Copy', action: () => {
                                navigator.clipboard.writeText(messageContent.innerText);
                            }},
                            { text: 'Edit', action: () => {
                                const newText = prompt('Edit message:', messageContent.innerText);
                                if (newText !== null) {
                                    messageContent.innerText = newText;
                                }
                            }}
                        ];

                        menuItems.forEach(item => {
                            const menuItem = document.createElement('div');
                            menuItem.innerText = item.text;
                            menuItem.style.padding = '10px 24px';
                            menuItem.style.cursor = 'pointer';
                            menuItem.style.color = '#fff';
                            menuItem.style.fontSize = '14px';
                            menuItem.style.transition = 'all 0.2s ease';
                            menuItem.addEventListener('mouseover', () => {
                                menuItem.style.backgroundColor = '#333';
                                menuItem.style.transform = 'translateX(4px)';
                            });
                            menuItem.addEventListener('mouseout', () => {
                                menuItem.style.backgroundColor = 'transparent';
                                menuItem.style.transform = 'translateX(0)';
                            });
                            menuItem.addEventListener('click', () => {
                                item.action();
                                contextMenu.remove();
                            });
                            contextMenu.appendChild(menuItem);
                        });

                        const style = document.createElement('style');
                        style.textContent = `
                            @keyframes fadeIn {
                                from { opacity: 0; transform: scale(0.95); }
                                to { opacity: 1; transform: scale(1); }
                            }
                        `;
                        document.head.appendChild(style);

                        document.body.appendChild(contextMenu);

                        document.addEventListener('click', function closeMenu() {
                            contextMenu.remove();
                            document.removeEventListener('click', closeMenu);
                        });
                    });

                    messageElement.addEventListener('touchstart', function(e) {
                        let timer = setTimeout(() => {
                            e.preventDefault();
                            const existingMenus = document.querySelectorAll('.context-menu');
                            existingMenus.forEach(menu => menu.remove());

                            const touch = e.touches[0];
                            const contextMenu = document.createElement('div');
                            contextMenu.classList.add('context-menu');
                            contextMenu.style.position = 'fixed';
                            contextMenu.style.left = touch.pageX + 'px';
                            contextMenu.style.top = touch.pageY + 'px';
                            contextMenu.style.backgroundColor = '#1a1a1a';
                            contextMenu.style.border = '1px solid #333';
                            contextMenu.style.borderRadius = '8px';
                            contextMenu.style.padding = '8px 0';
                            contextMenu.style.boxShadow = '0 4px 12px rgba(0,0,0,0.4)';
                            contextMenu.style.zIndex = '1000';
                            contextMenu.style.animation = 'fadeIn 0.2s ease-out';

                            const menuItems = [
                                { text: 'Remove', action: () => messageElement.remove() },
                                { text: 'Copy', action: () => {
                                    navigator.clipboard.writeText(messageContent.innerText);
                                }},
                                { text: 'Edit', action: () => {
                                    const newText = prompt('Edit message:', messageContent.innerText);
                                    if (newText !== null) {
                                        messageContent.innerText = newText;
                                    }
                                }}
                            ];

                            menuItems.forEach(item => {
                                const menuItem = document.createElement('div');
                                menuItem.innerText = item.text;
                                menuItem.style.padding = '10px 24px';
                                menuItem.style.cursor = 'pointer';
                                menuItem.style.color = '#fff';
                                menuItem.style.fontSize = '14px';
                                menuItem.style.transition = 'all 0.2s ease';
                                menuItem.addEventListener('click', () => {
                                    item.action();
                                    contextMenu.remove();
                                });
                                contextMenu.appendChild(menuItem);
                            });

                            document.body.appendChild(contextMenu);

                            document.addEventListener('click', function closeMenu() {
                                contextMenu.remove();
                                document.removeEventListener('click', closeMenu);
                            });
                        }, 500);

                        messageElement.addEventListener('touchend', () => {
                            clearTimeout(timer);
                        });
                    });

                    chatBox.appendChild(messageElement);
                    chatBox.scrollTop = chatBox.scrollHeight;
                } catch (error) {
                    console.error('Error fetching persona:', error);
                }
                messageInput.value = '';


                const settings = JSON.parse(localStorage.getItem('settings')) || {};

                const typingIndicator = document.createElement('div');
                typingIndicator.className = 'message bot';
                typingIndicator.innerHTML = `
                    <div class="message-content" style="display: flex; align-items: center; gap: 4px;">
                        <div class="typing-indicator" style="display: flex; gap: 4px;">
                            <div style="width: 6px; height: 6px; border-radius: 50%; background: #B0B0B0; animation: bounce 1.2s infinite"></div>
                            <div style="width: 6px; height: 6px; border-radius: 50%; background: #B0B0B0; animation: bounce 1.2s infinite 0.3s"></div>
                            <div style="width: 6px; height: 6px; border-radius: 50%; background: #B0B0B0; animation: bounce 1.2s infinite 0.6s"></div>
                        </div>
                    </div>
                    <style>
                        @keyframes bounce {
                            0%, 80%, 100% { transform: translateY(0); }
                            40% { transform: translateY(-8px); }
                        }
                    </style>
                `;
                chatBox.appendChild(typingIndicator);
                chatBox.scrollTop = chatBox.scrollHeight;

                try {
                    if (!characterData || !characterData.name || !characterData.description || 
                        !characterData.modelInstructions || !characterData.system || 
                        !characterData.persona || !characterData.firstMessage) {
                        throw new Error('Character data is missing required fields');
                    }

                    const headers = {
                        'Content-Type': 'application/json'
                    };

                    const checkerResponse = await fetch('https://serger.onrender.com/api/v1/server/checker/post', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            name: characterData.name,
                            description: characterData.description,
                            modelInstructions: characterData.modelInstructions,
                            system: characterData.system,
                            persona: characterData.persona,
                            firstMessage: characterData.firstMessage
                        })
                    });

                    if (!checkerResponse.ok) {
                        throw new Error('Checker post request failed');
                    }

                    const getCheckerResponse = await fetch('https://serger.onrender.com/api/v1/server/checker/get', {
                        method: 'GET',
                        headers: headers,
                        credentials: 'include'
                    });

                    if (!getCheckerResponse.ok) {
                        throw new Error('Failed to get checker data');
                    }

                    const getCheckerData = await getCheckerResponse.json();
                    const decodedData = atob(getCheckerData.data);
                    const parsedData = JSON.parse(decodedData);

                    const response = await fetch('https://server-hhcx.onrender.com/generatetext', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            prompt: messageText,
                            max_tokens: settings.max_tokens || 100,
                            top_k: settings.top_k || 50,
                            temperature: settings.temperature || 0.7,
                            character: {
                                name: parsedData.name,
                                description: parsedData.description, 
                                modelInstructions: parsedData.modelInstructions,
                                system: parsedData.system,
                                persona: parsedData.persona,
                                firstMessage: parsedData.firstMessage
                            }
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to get bot response');
                    }

                    const data = await response.json();
                    const botResponse = data.model_response?.result?.response;
                    
                    if (!botResponse) {
                        throw new Error('Invalid response format from server');
                    }

                    typingIndicator.remove();

                    let botMessageElement = document.createElement('div');
                    botMessageElement.classList.add('message', 'bot');

                    let botMessageContent = document.createElement('div');
                    botMessageContent.classList.add('message-content');
                    botMessageElement.appendChild(botMessageContent);

                    let botTimeStamp = document.createElement('div');
                    botTimeStamp.classList.add('message-time');
                    currentTime = new Date();
                    botTimeStamp.innerText = currentTime.getHours() + ':' + String(currentTime.getMinutes()).padStart(2, '0');
                    botMessageElement.appendChild(botTimeStamp);

                    chatBox.appendChild(botMessageElement);

                    let activeMenu = null;

                    botMessageElement.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        
                        if (activeMenu) {
                            activeMenu.remove();
                        }

                        const menu = document.createElement('div');
                        menu.style.position = 'fixed';
                        menu.style.left = e.pageX + 'px';
                        menu.style.top = e.pageY + 'px';
                        menu.style.backgroundColor = 'rgba(0,0,0,0.95)';
                        menu.style.backdropFilter = 'blur(10px)';
                        menu.style.border = '1px solid rgba(255,255,255,0.1)';
                        menu.style.padding = '12px';
                        menu.style.borderRadius = '12px';
                        menu.style.boxShadow = '0 8px 32px rgba(0,0,0,0.4)';
                        menu.style.opacity = '0';
                        menu.style.transform = 'scale(0.95) translateY(10px)';
                        menu.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';

                        const menuItems = [
                            {text: 'Copy', action: () => {
                                navigator.clipboard.writeText(botMessageContent.innerText);
                            }},
                            {text: 'Edit', action: () => {
                                const input = document.createElement('textarea');
                                input.value = botMessageContent.innerText;
                                input.style.width = '100%';
                                input.style.minHeight = '100px';
                                input.style.padding = '8px';
                                input.style.backgroundColor = '#222';
                                input.style.color = '#fff';
                                input.style.border = '1px solid #444';
                                input.style.borderRadius = '4px';
                                botMessageContent.innerHTML = '';
                                botMessageContent.appendChild(input);
                                input.focus();
                                
                                input.addEventListener('blur', () => {
                                    botMessageContent.innerText = input.value;
                                });
                            }},
                            {text: 'Regenerate', action: async () => {
                                botMessageElement.remove();
                                handleMessage();
                            }},
                            {text: 'Continue', action: async () => {
                                const currentText = botMessageContent.innerText;
                                handleMessage(`Continue from: ${currentText}`);
                            }},
                            {text: 'Rewind', action: () => {
                                const messages = chatBox.querySelectorAll('.message');
                                let found = false;
                                messages.forEach(msg => {
                                    if (found) {
                                        msg.style.opacity = '0';
                                        msg.style.transform = 'scale(0.9)';
                                        setTimeout(() => msg.remove(), 300);
                                    }
                                    if (msg === botMessageElement) found = true;
                                });
                            }},
                            {text: 'Delete', action: () => {
                                botMessageElement.style.opacity = '0';
                                botMessageElement.style.transform = 'scale(0.9)';
                                setTimeout(() => botMessageElement.remove(), 300);
                            }}
                        ];

                        menu.innerHTML = menuItems.map(item => `
                            <div class="menu-item" style="
                                cursor: pointer;
                                padding: 10px 20px;
                                color: white;
                                font-size: 14px;
                                display: flex;
                                align-items: center;
                                gap: 12px;
                                border-radius: 8px;
                                transition: all 0.3s;
                                margin: 4px 0;
                                background: transparent;
                                transform: translateX(0);
                            " onmouseover="this.style.transform='translateX(8px)';this.style.background='rgba(255,255,255,0.1)'" 
                               onmouseout="this.style.transform='translateX(0)';this.style.background='transparent'">
                                <span>${item.text}</span>
                            </div>
                        `).join('');

                        document.body.appendChild(menu);
                        activeMenu = menu;

                        const menuItems_elements = menu.querySelectorAll('.menu-item');
                        menuItems_elements.forEach((element, index) => {
                            element.addEventListener('click', () => {
                                menuItems[index].action();
                                menu.remove();
                            });
                        });

                        requestAnimationFrame(() => {
                            menu.style.opacity = '1';
                            menu.style.transform = 'scale(1) translateY(0)';
                        });

                        document.addEventListener('click', function closeMenu(e) {
                            if (!menu.contains(e.target)) {
                                menu.style.opacity = '0';
                                menu.style.transform = 'scale(0.95) translateY(10px)';
                                setTimeout(() => menu.remove(), 300);
                                document.removeEventListener('click', closeMenu);
                            }
                        });
                    });

                    let longPressTimer;
                    botMessageElement.addEventListener('touchstart', () => {
                        longPressTimer = setTimeout(() => {
                            if (activeMenu) {
                                activeMenu.remove();
                            }

                            const menu = document.createElement('div');
                            menu.style.position = 'fixed';
                            menu.style.left = '50%';
                            menu.style.top = '50%';
                            menu.style.width = '80%';
                            menu.style.maxWidth = '300px';
                            menu.style.transform = 'translate(-50%, -50%) scale(0.95)';
                            menu.style.backgroundColor = 'rgba(0,0,0,0.95)';
                            menu.style.backdropFilter = 'blur(10px)';
                            menu.style.border = '1px solid rgba(255,255,255,0.1)';
                            menu.style.padding = '16px';
                            menu.style.borderRadius = '16px';
                            menu.style.boxShadow = '0 8px 32px rgba(0,0,0,0.4)';
                            menu.style.opacity = '0';
                            menu.style.transition = 'all 0.3s cubic-bezier(0.4, 0, 0.2, 1)';

                            const menuItems = [
                                {text: 'Copy', action: () => {
                                    navigator.clipboard.writeText(botMessageContent.innerText);
                                }},
                                {text: 'Edit', action: () => {
                                    const input = document.createElement('textarea');
                                    input.value = botMessageContent.innerText;
                                    input.style.width = '100%';
                                    input.style.minHeight = '100px';
                                    input.style.padding = '8px';
                                    input.style.backgroundColor = '#222';
                                    input.style.color = '#fff';
                                    input.style.border = '1px solid #444';
                                    input.style.borderRadius = '4px';
                                    botMessageContent.innerHTML = '';
                                    botMessageContent.appendChild(input);
                                    input.focus();
                                    
                                    input.addEventListener('blur', () => {
                                        botMessageContent.innerText = input.value;
                                    });
                                }},
                                {text: 'Regenerate', action: async () => {
                                    botMessageElement.remove();
                                    handleMessage();
                                }},
                                {text: 'Continue', action: async () => {
                                    const currentText = botMessageContent.innerText;
                                    handleMessage(`Continue from: ${currentText}`);
                                }},
                                {text: 'Rewind', action: () => {
                                    const messages = chatBox.querySelectorAll('.message');
                                    let found = false;
                                    messages.forEach(msg => {
                                        if (found) {
                                            msg.style.opacity = '0';
                                            msg.style.transform = 'scale(0.9)';
                                            setTimeout(() => msg.remove(), 300);
                                        }
                                        if (msg === botMessageElement) found = true;
                                    });
                                }},
                                {text: 'Delete', action: () => {
                                    botMessageElement.style.opacity = '0';
                                    botMessageElement.style.transform = 'scale(0.9)';
                                    setTimeout(() => botMessageElement.remove(), 300);
                                }}
                            ];

                            menu.innerHTML = menuItems.map(item => `
                                <div class="menu-item" style="
                                    cursor: pointer;
                                    padding: 12px 24px;
                                    color: white;
                                    font-size: 16px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    border-radius: 8px;
                                    transition: all 0.3s;
                                    margin: 8px 0;
                                    background: transparent;
                                    transform: translateY(0);
                                " onmouseover="this.style.transform='translateY(-4px)';this.style.background='rgba(255,255,255,0.1)'" 
                                   onmouseout="this.style.transform='translateY(0)';this.style.background='transparent'">
                                    <span>${item.text}</span>
                                </div>
                            `).join('');

                            document.body.appendChild(menu);
                            activeMenu = menu;

                            const menuItems_elements = menu.querySelectorAll('.menu-item');
                            menuItems_elements.forEach((element, index) => {
                                element.addEventListener('click', () => {
                                    menuItems[index].action();
                                    menu.remove();
                                });
                            });

                            requestAnimationFrame(() => {
                                menu.style.opacity = '1';
                                menu.style.transform = 'translate(-50%, -50%) scale(1)';
                            });

                            document.addEventListener('click', function closeMenu() {
                                menu.style.opacity = '0';
                                menu.style.transform = 'translate(-50%, -50%) scale(0.95)';
                                setTimeout(() => menu.remove(), 300);
                                document.removeEventListener('click', closeMenu);
                            });
                        }, 500);
                    });

                    botMessageElement.addEventListener('touchend', () => {
                        clearTimeout(longPressTimer);
                    });

                    if (data?.model_response?.result?.response) {
                        for (let i = 0; i < data.model_response.result.response.length; i++) {
                            botMessageContent.innerText = data.model_response.result.response.substring(0, i + 1);
                            chatBox.scrollTop = chatBox.scrollHeight;
                            await new Promise(resolve => setTimeout(resolve, 20));
                        }
                    } else {
                        throw new Error('Invalid response format');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    typingIndicator.remove();
                    
                    let errorMessageElement = document.createElement('div');
                    errorMessageElement.classList.add('message', 'bot');
                    
                    let errorContent = document.createElement('div');
                    errorContent.classList.add('message-content');
                    errorMessageElement.appendChild(errorContent);
                    
                    let errorTimeStamp = document.createElement('div');
                    errorTimeStamp.classList.add('message-time');
                    currentTime = new Date();
                    errorTimeStamp.innerText = currentTime.getHours() + ':' + String(currentTime.getMinutes()).padStart(2, '0');
                    errorMessageElement.appendChild(errorTimeStamp);
                    
                    chatBox.appendChild(errorMessageElement);
                    
                    const errorMessage = 'Sorry, I encountered an error processing your message.';
                    for (let i = 0; i < errorMessage.length; i++) {
                        errorContent.innerText = errorMessage.substring(0, i + 1);
                        chatBox.scrollTop = chatBox.scrollHeight;
                        await new Promise(resolve => setTimeout(resolve, 20));
                    }
                }
            }
        }

        document.getElementById('sendBtn').addEventListener('click', handleMessage);
        
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleMessage();
            }
        });

        document.getElementById('messageInput').focus();
    </script>
</body>

</html>
